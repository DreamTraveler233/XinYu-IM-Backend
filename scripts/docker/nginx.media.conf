# Nginx 示例配置：将 /media/ 映射到后端上传目录
# 指定运行方式：
#   nginx -c /absolute/path/to/scripts/docker/nginx.media.conf
# 以下示例假设项目根目录为 /home/szy/code/IM/IM-backend
# 并且默认的 upload_base_dir 为 data/uploads

error_log  /home/szy/code/IM/IM-backend/scripts/docker/nginx.error.log  warn;
pid        /home/szy/code/IM/IM-backend/scripts/docker/nginx.pid;
worker_processes  1;

events { worker_connections  1024; 
}
http {
    # Ensure nginx client body temp path is configured so nginx proxies can write request bodies
    client_body_temp_path /var/cache/nginx/client_temp 1 2k;
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # 将 /media/ 映射为 data/uploads/
    server {
        listen 9001; # 选择一个开发端口
        server_name localhost;

        # Optional: 允许 CORS 访问图片（只有当图片跨域访问于前端时才需要）
        add_header Access-Control-Allow-Origin *;

        # 映射 /media/ 到 media.upload_base_dir 指定的目录 (alias 路径需以 / 结尾)
        location /media/ {
            alias /var/lib/im/media/; # 默认值，确保与 bin/config/media.yaml 中 upload_base_dir 一致
            expires 30d;
            # 必要时可添加以下头以便 CDN/跨域加载图片
            add_header Access-Control-Allow-Origin "*" always;
            access_log off;
            add_header Cache-Control "public";
            # 对某些类型的文件进行 Content-Type 校正
            try_files $uri $uri/ =404;
        }

        # 其它 proxy 示例（可按需启用）
        # 代理 API
        location /api/ {
            proxy_pass http://127.0.0.1:8080;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
